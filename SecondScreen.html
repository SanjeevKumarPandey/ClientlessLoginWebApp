<!DOCTYPE html>
<!--{Author: Sanjeev Pandey| Ver.: Beta}-->
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="LoginWebApp">
    <meta name="author" content="Sanjeev Pandey">
    <meta http-equiv="Cache-Control" content="no-cache">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>LoginWebApp by Sanjeev</title>
    <link href="./Asset_files/bootstrap.css" rel="stylesheet">
    <link href="./Asset_files/index_content.css" rel="stylesheet">
    <link href="./Asset_files/customstyle.css" rel="stylesheet">
    <link href="./Asset_files/style.css" rel="stylesheet">
    <style>
    body {
    background-color: transparent;
    /* background-position: right !important; */
    background: url('./Asset_files/stewie.png');
    background-repeat: no-repeat;
    background-attachment: fixed;
    background-size: 12%;
    background-position: 20px 20px;
    }
    </style>

    <script src="./Asset_files/jquery.min.js.download"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
	<script src="https://code.jquery.com/jquery-1.10.2.js"></script>
    <script type="text/javascript">

        var mvpd_picker = document.getElementById('reg');
        window.onclick = function(event) {
            if (event.target == mvpd_picker) {
                mvpd_picker.style.display = "none";
            }
        }
            
        //Flow
        /*
        Enter Regcode, and requestor ID
        hit Submit; (registration record is fetched)
        If record is available --> MVPD Picker is created
        Pick the MVPD (mso id is set); click Login to send the authenticate call
        (let browser handle the redirects, set _this_ html page as redirect_url*)
        *By spoofing the localhost to adobe.com.
        */
        
        var uuid_filename = 'uuid.txt',
        login_page = 'mvpdLoginPage.html',
        deviceId = 'sanjeev',
        redirect_page = 'redirect_complete.html';
        var reggie_fqdn = 'http://api.auth.adobe.com/reggie/v1/';
        var sp_fqdn = "http://api.auth.adobe.com/api/v1/";
        var url_hdr = "Dalvik/2.1.0 (Linux; U; Android 6.0; Android SDK built for x86_64 Build/MASTER)";
        var url_hdr_alt = 'Mozilla 5.10';
        var redirect_url = 'http%3A%2F%2Fadobe.com%3A5500%2FLoginWebApp%2FSecondScreen.html'; //'http%3A%2F%2Fadobe.com%3A5500%2FSecondScreen.html';//'http://www.foxnow.com';
        var mvpdList = [];
        var REQUESTOR, RESOURCE = "sample_requestor_Id", REGCODE = null, mso = 'Cablevision', picker, mvpds;
        var counter = false;
        
        function regRecord(requestor_id, regcode){
        document.getElementById('dir').innerHTML = `Enter \${${regcode}}, and \${${requestor_id}}
            hit Submit (registration record is fetched).
            <span style="font-weight:bold;">If</span> record is available -> MVPD Picker is created.
            Pick the MVPD (\${mso} id is set); click <span style="font-weight:bold;">Login</span> to send the authenticate call
            (browser handles redirects & cookies). Set <span style="font-style:italic;">this</span> html page as redirect_url*.
            <br>*By spoofing the localhost to adobe.com.`;
        var http = new XMLHttpRequest();
        var url = `${reggie_fqdn}${requestor_id}/regcode/${regcode}.json`;
        var params = JSON.stringify({'deviceId': deviceId, 'User-Agent': url_hdr});
        http.open("GET", url, true);
        http.onreadystatechange = function() {
            if(http.readyState == 4 && http.status == 200) {
                var a = JSON.stringify(http.responseText);
                document.getElementById('textbox').value += '\n'+a;
                //window.location.replace(url);
                getMVPD(document.getElementById('requestor').value);
            } else {
                var a = JSON.stringify(http.responseText);
                document.getElementById('textbox').value += '\n'+a;
            }
        }
        http.send(params);
        }
        
        
        function getMVPD(requestor_id){
        var url = `https://sp.auth.adobe.com/adobe-services/config/${requestor_id}.json`;
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange=function(){
        if (xmlhttp.readyState==4 || xmlhttp.status==200)
        {
            document.getElementById('textbox').value += xmlhttp.responseText;
            try {
            var x =  $.parseXML(xmlhttp.responseText);
            mvpds = $(x).find('mvpd');
            picker = $('#mvpdPicker');
            var providersMenu = $('<select id="mvpdList" multiple></select>');
            
            var promise = new Promise(function(resolve, reject) {
                $.each(mvpds, function(k, v) {
                            var mvpdID = $(v).find("id").text();
                            var mvpdName = $(v).find("displayName").text();
                            providersMenu.append($('<option></option>', {value:mvpdID}).text(mvpdName));
                            //mvpdList.push(mvpds[v].childNodes[0].textContent);
                            mvpdList.push($(v).find("id").text());
                            //return mvpdList;
                            counter = true;
                        });
            
                if(counter){
                
                function createPicker(){
                    picker.append(providersMenu);
                        picker.append($('<br/>'));
                        picker.append($('<input type="button" class="login-stuff" onclick="authenticate()" value="login" style="width:auto;" />'));
                        picker.append($('<input type="button" class="login-stuff" onclick="cancelPicker()" value="cancel" style="width:auto; background-color:orange;" />'));
                        counter = false;
                        };
                
                resolve (createPicker());
                
                } else {
                        reject(Error("It broke"));
                }				
            });
            
            var askMe = function () {
            promise
                .then(function (fulfilled) {
                    //console.log(fulfilled);
                })
                .catch(function (error) {
                    console.log(error.message);
                });
        };
        
        askMe();
            
            } catch (ex) {
                console.log('Error');
            }
            
        }
        }
        xmlhttp.open('GET',url,true);
        xmlhttp.send();
        
        //document.getElementById(&#39;reg&#39;).style.display=&#39;block&#39;
        
        }
        /* --- Authentication (INCORRECT) Flow --- */
        /*
        function _callback(data) {
           if(data != null){
           console.log('Data is there!');
           return data;
           }
        return data;
        }
        
        var url;
        function login(url, callback){
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange=function(){
        if (xmlhttp.readyState==4 || xmlhttp.status==200)
        {
            //url =	xmlhttp.response;
            callback(xmlhttp.response);
            window.location.assign(xmlhttp.response);
            
        }else{
            console.log('Oops! Login failed');
        }
        }
        xmlhttp.open('GET',url,true);
        try {
            xmlhttp.responseType = 'document';
          } catch(e) {
            console.error(e);
          }
        xmlhttp.send();
        }*/

        function login(_url){

            window.location.replace(_url);
        }
        
        function authenticate(){
        mso = document.getElementById('mvpdList').value;
        REQUESTOR = document.getElementById('requestor').value;
        REGCODE = document.getElementById('regcode').value;
        var url = `${sp_fqdn}authenticate?reg_code=${REGCODE}&requestor_id=${REQUESTOR}&domain_name=adobe.com&noflash=true&no_iframe=true&mso_id=${mso}&redirect_url=${redirect_url}`;
        //login(url, _callback);
        login(url);
        }
        
        
        function checkauthn(req, regC){
        var url = `${sp_fqdn}checkauthn/${regC}.json?requestor=${req}&deviceId=${deviceId}`;
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function(){
            if (xhr.readyState===4 && xhr.status===200){
                var rt = xhr.responseText;
                document.getElementById('textbox').value += 'Authentication Status: '+rt;
            } else {
                console.log('[/checkauthn] XHR Error');
            }
        }
        xhr.open('GET', url, true);
        xhr.send();
        }
</script>        

</head>
<body>
<div class="container-fluid">
  <div class="row">
    <div class="col-sm-12" style="background-color:none;">
      <div class="col-lg-12 col-md-12 ">
        <div id="gps_ring" class="gps_ring"></div>
        <div class="login-form">
          <!--Activation Form-->
		  <h1>Activation Screen</h1><br>
          <input type="text" name="regcode" placeholder="REGCODE" id="regcode"><br>
          <input type="text" name="requestor" placeholder="REQUESTOR ID" id="requestor"><br>
          <button type="button" class="login-stuff" onclick="regRecord(document.getElementById('requestor').value, document.getElementById('regcode').value)" style="width:auto;">Submit</button>

          <button id="register_btn" class="login-stuff" onclick="document.getElementById('reg').style.display='block';" style="width:auto; display:none;">Set MVPD</button><br>
          <p id="unauths"></p>
          <p id="unauthe"></p>
		  <div id="mvpdPicker"></div>
		  <textarea cols="50" rows="4" name="comment" class='tb' id='textbox' style="width:330px; height:200px;"></textarea>
		  <button type="button" class="login-stuff" id='test' onclick="checkauthn(document.getElementById('requestor').value, document.getElementById('regcode').value)" style="width:auto; background-color:green;">Check Auth</button>
		  <button type="button" class="login-stuff" id="create" style="width:auto;" >Download Logs</button>
        </div>

        <!--MVPD Picker - THIS IS NOT USED BY IS ON STANDBY FOR FUTURE IMPLEMENTATIONS-->
        <div class="mvpd_picker" id="reg">
          <div class="mvpd_picker-content animate">
            <div class="imgcontainer">
              <span onclick="document.getElementById('reg').style.display='none';" class="close" title="Close mvpd_picker">×</span>
              <h1>Pick MVPD</h1>
            </div>
			<div id="container3">
            <input type="text" name="mso_id" placeholder="Pick mso id" id="pick_mso"> 
			<select id='mvpdlist'></select>
            <button type="button" class="login-stuff" onclick="authenticate(document.getElementById('pick_mso').value)" style="width:auto;">Set</button>
            <button type="button" onclick="document.getElementById('reg').style.display='none';" class="login-stuff" style="width:auto; background-color:orange">Cancel</button>
          </div>
          </div>
        </div>
        <!--Directions-->
        <div class="col-lg-4 col-md-4 "><h1>Directions-</h1>
        <p id='dir'>Enter ${REGCODE}, and ${REQUESTOR ID}
            hit Submit (registration record is fetched).
            <span style="font-weight:bold;">If</span> record is available -> MVPD Picker is created.
            Pick the MVPD (${mso} id is set); click <span style="font-weight:bold;">Login</span> to send the authenticate call
            (browser handles redirects & cookies). Set <span style="font-style:italic;">this</span> html page as redirect_url*.
            <br>*By spoofing the localhost to adobe.com.</p></div>
      </div>
    </div>
  </div>
</div>
<p id="demo"></p>
<hr style='margin-top:25%;'>
&copy;Sanjeev Pandey
<script lang="javascript">
    try{
            var textFile = null,
                              makeTextFile = function (text) {
                            var data = new Blob([text], {type: 'text/plain'});
        
                            //Manually revoke the object-URL to avoid memory leaks while previous file is replaced
                            if (textFile !== null) {
                              window.URL.revokeObjectURL(textFile);
                            }
        
                            textFile = window.URL.createObjectURL(data);
        
                            // This returned url is being used as a href
                            return textFile;
                              };
        
                            var create = document.getElementById('create'),
                            textbox = document.getElementById('textbox');
        
                              create.addEventListener('click', function () {
                            var link = document.createElement('a');
                            link.setAttribute('download', 'xmlData.xml');
                            link.href = makeTextFile(textbox.value);
                            document.body.appendChild(link);
        
                            // wait for the link to be added to the document
                            window.requestAnimationFrame(function () {
                              var event = new MouseEvent('click');
                              link.dispatchEvent(event);
                              document.body.removeChild(link);
                            });
        
                              }, false);
        
                            } catch (ex) {
                            console.error(ex);
                            }
</script>
</body>
</html>
